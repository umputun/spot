user: umputun

targets:
    remark42:
      hosts: ["h1.example.com", "h2.example.com"]
    staging:
      inventory: "file://inventory/staging.yml"


tasks:

  deploy-remark42:
    before: "curl https://example.com/before"
    after: "curl https://example.com/after"
    onerror: "curl https://example.com/after/{{.Command.Name}}"
    warn_duration: 3s

    commands:
      - name: wait
        script: sleep 5

      - name: copy configuration
        copy: {"src": "/local/remark42.yml", "dst": "/srv/remark42.yml", "mkdir": true}

      - name: some local command
        options: {local: true}
        script: |
          ls -la /srv
          du -hcs /srv

      - name: git
        before: "echo before git"
        after: "echo after git"
        onerror: "echo onerror git"
        script: |
          git clone https://example.com/remark42.git /srv || true # clone if doesn't exists, but don't fail if exists
          cd /srv
          git pull

      - name: docker
        options: {no_auto: true}
        script: |
          docker pull umputun/remark42:latest
          docker stop remark42 || true
          docker rm remark42 || true
          docker run -d --name remark42 -p 8080:8080 umputun/remark42:latest